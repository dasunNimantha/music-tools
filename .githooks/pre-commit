#!/bin/sh
# Pre-commit hook for music-tools
# Runs cargo fmt to ensure code is formatted

# Source cargo environment if available
if [ -f "$HOME/.cargo/env" ]; then
    . "$HOME/.cargo/env"
fi

echo "üîç Running cargo fmt..."

# Check if cargo is available
if ! command -v cargo >/dev/null 2>&1; then
    # Try common cargo locations
    if [ -x "$HOME/.cargo/bin/cargo" ]; then
        export PATH="$HOME/.cargo/bin:$PATH"
    else
        echo "‚ùå cargo not found. Please install Rust."
        exit 1
    fi
fi

# Run cargo fmt to automatically fix formatting
echo "üîß Auto-formatting code..."
cargo fmt --all
FMT_STATUS=$?

if [ $FMT_STATUS -ne 0 ]; then
    echo ""
    echo "‚ùå Failed to format code!"
    echo ""
    exit 1
fi

# Stage the formatted files
git add -u

echo "‚úÖ Code formatted and staged"

# Optional: Run clippy (uncomment to enable)
# echo "üîç Running clippy..."
# cargo clippy --all-targets --all-features -- -D warnings
# if [ $? -ne 0 ]; then
#     echo "‚ùå Clippy found issues!"
#     exit 1
# fi
# echo "‚úÖ Clippy OK"

exit 0

